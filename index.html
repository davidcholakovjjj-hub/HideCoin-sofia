
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ü™ô HIDECOIN Sofia</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --purple1: #667eea;
      --purple2: #764ba2;
      --btn-main: linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
      --btn-sec: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
      --glass: rgba(255,255,255,0.09);
      --glass2: rgba(255,255,255,0.19);
    }
    *, *::before, *::after { box-sizing: border-box }
    html { font-size: 16px }
    body {
      font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg, var(--purple1) 0%, var(--purple2) 100%);
      min-height: 100vh;
      margin:0; color:#fff;
    }
    .navbar {
      background: var(--glass);
      border-bottom: 1px solid var(--glass2);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky; top: 0; z-index: 1500;
      box-shadow:0 8px 32px rgba(0,0,0,0.10);
    }
    .navbar-brand { display:flex; align-items:center; gap:10px; font-size:1.6rem; font-weight:800; color:#fff;}
    .navbar-brand i { font-size:2.1rem; animation:spin 4s linear infinite }
    @keyframes spin { 0%,100%{transform:rotate(0)} 50%{transform:rotate(180deg);} }
    .navbar-menu { display:flex; gap:5px; }
    .nav-link {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      padding: 7px 16px;
      border-radius: 14px;
      transition: all .18s;
      font-size: 1rem;
      background: var(--glass);
      border: 1.5px solid transparent;
      margin: 0 2px;
    }
    .nav-link:hover, .nav-link.active {
      border: 1.5px solid #fff;
      background: var(--glass2);
      box-shadow:0 1px 8px rgba(0,0,0,0.11);
      color: #fff;
    }
    .btn {
      display:inline-flex; align-items:center; gap:8px;
      padding: 12px 19px;
      border:none;
      border-radius: 12px;
      font-weight:600; cursor:pointer; font-size:1rem;
      box-shadow:0 2.5px 11px rgba(0,0,0,0.16);
      transition: all .17s;
    }
    .btn[disabled] { opacity: 0.57; cursor: not-allowed }
    .btn-primary { background: var(--btn-main); color:#fff; }
    .btn-primary:hover { transform:translateY(-2px);}
    .btn-success { background: var(--btn-sec); color:#fff;}
    .btn-success:hover { transform:translateY(-2px);}
    .container { width: 100%; max-width:1140px; margin:30px auto; padding:0 12px;}
    .card {
      background: var(--glass2);
      border-radius: 24px;
      border: 1px solid var(--glass2);
      box-shadow:0 8px 32px rgba(0,0,0,0.10);
      padding: 32px 22px 25px 22px;
      margin-bottom: 25px;
      animation: fadeIn 0.5s;
      position:relative;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(19px);} to{opacity:1; transform:translateY(0);} }
    .card h2 {
      font-size:1.7rem;margin-bottom: 15px;letter-spacing: .01em;
      text-shadow: 0 2px 11px rgba(0,0,0,0.16);
    }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .form-group { margin-bottom:17px; }
    .form-group label { display:block;font-weight:600;color:#fff;font-size:1.06rem;margin-bottom:6px;}
    .form-control {
      width:100%;padding:11px 16px;
      background:rgba(255,255,255,0.21); color:#fff;
      border:2px solid var(--glass2); border-radius: 10px;
      margin-top:3px; margin-bottom:2px;
      font-size:1.02rem; font-family:inherit;
      transition: all .22s;
    }
    .form-control:focus { outline:none; border-color: #fff;}
    textarea.form-control { resize: vertical; min-height: 80px;}
    select.form-control { background: rgba(255,255,255,0.19); }
    .stats-grid { display: grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:17px;margin:20px 0; }
    .stat-card { background: var(--glass); border-radius:14px; padding:15px 10px;text-align:center;}
    .stat-card .number { font-size:2rem;font-weight:800;margin:10px 0 3px 0;letter-spacing:.01em;}
    .badge,.rarity-badge {display: inline-block; border-radius:22px;padding:5px 13px; font-size:.92rem; font-weight:700;}
    .badge-hider {background:var(--btn-main);}
    .badge-finder {background:var(--btn-sec);}
    .d-none {display:none !important;}
    .text-center {text-align: center;}
    .mt-20 {margin-top: 20px;}
    .mt-10 {margin-top: 10px;}
    .w-100 {width: 100%;}
    .modal {
      display:none;
      position:fixed; top:0; left:0;width:100vw;height:100vh;
      background:rgba(20,16,30,0.92);backdrop-filter:blur(7px);
      z-index:2100; justify-content: center; align-items: center;
      transition:opacity .26s;
    }
    .modal.show { display:flex; opacity:1; }
    .modal-content {
      background:var(--glass2);
      padding:32px 22px; border-radius: 22px;
      border:1.5px solid var(--glass2);
      max-width:415px; width:98vw;
      box-shadow:0 9px 49px rgba(0,0,0,.23);
      animation:slideUp .33s;
    }
    @keyframes slideUp { from{ transform:translateY(54px); opacity:0;} to{ transform: none;opacity: 1;} }
    .modal-content h3 {margin-bottom:19px; font-size:1.45rem;}
    .profiles-grid,.coin-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:16px;}
    .coin-card,.profile-card {
      background:var(--glass);
      border-radius:18px; padding:20px 10px;
      border:1px solid var(--glass2); transition:all .23s;
      box-shadow:0 2.5px 10px rgba(0,0,0,0.09);
      position:relative;
    }
    .coin-images { display:grid; grid-template-columns:1fr 1fr; gap:7px; margin:11px 0; }
    .coin-image {
      width:100%; height:95px; object-fit:cover; border-radius:8px;
      border:1.5px solid rgba(255,255,255,0.32)
    }
    .profile-card {text-align: center;}
    .profile-card h4 { margin-bottom: 7px; font-size:1.19rem; }
    .profile-stats {font-size:1.03rem;color:rgba(255,255,255,0.93);margin:7px 0;}
    .btn-group { display:flex; gap:9px; flex-wrap:wrap; margin: 13px 0 0 0;}
    .image-upload-container {
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
      margin-top:8px;margin-bottom:6px;
    }
    .image-upload-box {
      background:rgba(255,255,255,0.09);
      border:2.2px dashed rgba(255,255,255,0.34);
      border-radius:12px;
      padding:15px 5px 12px 5px;
      text-align:center; cursor:pointer;transition:.22s;
      min-height:98px; display:flex;flex-direction:column;align-items:center;justify-content:center; position:relative;
    }
    .image-upload-box.has-image { border-style:solid; border-color:#4facfe; }
    .image-upload-box i { font-size:2rem; margin-bottom: 7px;color:rgba(255,255,255,0.71);}
    .remove-image {
      position:absolute;top:7px;right:7px;
      background:#f5576c;color:#fff;border:none;border-radius:50%;
      width:23px;height:23px;display:none;align-items: center; justify-content:center;z-index:9;}
    .image-upload-box.has-image .remove-image {display:flex;}
    .image-preview {width:100%;max-height:70px;object-fit:cover;border-radius:6px;margin-bottom:6px;}
    .instructions {background:var(--glass);padding:18px;border-radius:12px;border: 1px solid var(--glass2);margin-top:16px;}
    .instructions h4 {color:#fff;margin-bottom: 11px;font-size:1.05rem;}
    .message {
      position:fixed; top:17px; right:23px;
      padding: 13px 22px; color:#fff;border-radius:11px;z-index: 2390;
      font-weight: 600; min-width:180px;text-align:center;
      font-size:1.06rem;box-shadow:0 4px 20px rgba(0,0,0,0.19);
      animation:slideIn .33s;
    }
    @keyframes slideIn {from{ right:-360px; opacity: 0;} to{ right:23px; opacity:1;}}
    /* Map & Picker Styles */
    #map-container, .location-picker {
      height: 44vw; min-height:340px; max-height:420px; width:100%;
      border-radius:19px; border:2.2px solid var(--glass2);
      margin:12px 0 15px 0; box-shadow:0 5px 23px rgba(0,0,0,0.12)
    }
    .location-picker { min-height:220px; max-height:248px;}
    @media (max-width: 800px) {
      .container {padding: 0 3vw;}
      .navbar {flex-direction:column; gap:11px;}
    }
    @media (max-width: 600px) {
      html {font-size:15px;}
      .container {padding: 0 2vw;}
      .stats-grid,.profiles-grid,.coin-grid {grid-template-columns:1fr;}
      .navbar-menu {flex-wrap:wrap;}
      #map-container,.location-picker { min-height:170px;}
      .modal-content {padding:16px 5px;}
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand"><i class="fas fa-coins"></i><span>HIDECOIN Sofia</span></div>
    <div class="navbar-menu">
      <a href="#" class="nav-link active" data-tab="home" aria-label="To Home"><i class="fas fa-home"></i> Home</a>
      <a href="#" class="nav-link" data-tab="map" aria-label="To Map"><i class="fas fa-map"></i> Map</a>
      <a href="#" class="nav-link" data-tab="hide" aria-label="To Hide Coin"><i class="fas fa-plus-circle"></i> Hide</a>
      <a href="#" class="nav-link" data-tab="find" aria-label="To Find Coin"><i class="fas fa-search"></i> Find</a>
      <a href="#" class="nav-link" data-tab="profiles" aria-label="To Profiles"><i class="fas fa-trophy"></i> Profiles</a>
    </div>
    <button class="btn btn-primary" id="auth-btn" aria-label="Login or logout"><i class="fas fa-user"></i> Login</button>
  </nav>
  <div class="container">
    <div id="home" class="tab-content active">
      <div class="card">
        <h2>üéÆ Welcome to HIDECOIN Sofia</h2>
        <p style="font-size:1.1rem;color:rgba(255,255,255,0.9);margin-bottom:20px">The ultimate coin hunt game in Sofia, Bulgaria!</p>
        <div id="user-info" class="d-none">
          <div class="user-badge">
            <div class="badge" id="user-role-badge">Guest</div>
            <p style="margin-top:10px;font-size:1.05rem" id="user-name"></p>
            <button class="btn btn-primary mt-10" id="logout-btn" type="button"><i class="fas fa-sign-out-alt"></i> Logout</button>
          </div>
        </div>
        <div class="stats-grid" id="stats-grid">
          <div class="stat-card"><i class="fas fa-coins" style="font-size:1.4rem;color:#ffd700"></i><span class="number" id="total-coins">0</span><span class="label">Total Coins</span></div>
          <div class="stat-card"><i class="fas fa-check-circle" style="font-size:1.4rem;color:#4facfe"></i><span class="number" id="found-coins">0</span><span class="label">Coins Found</span></div>
          <div class="stat-card"><i class="fas fa-star" style="font-size:1.4rem;color:#f5576c"></i><span class="number" id="my-found-coins">0</span><span class="label">Your Finds</span></div>
        </div>
        <div class="instructions">
          <h4><i class="fas fa-gamepad"></i> How to Play</h4>
          <p><strong>1.</strong> Click "Login" to start playing</p>
          <p><strong>2.</strong> Hider password: <code style="background:var(--glass2);padding:4px 8px;border-radius:6px;">nevergonnaknow</code></p>
          <p><strong>3.</strong> Hide coins with pictures or find them on the map!</p>
        </div>
      </div>
    </div>
    <div id="map" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-map-marked-alt"></i> Live Coin Map</h2>
        <div id="map-container"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="refresh-map-btn" type="button"><i class="fas fa-sync-alt"></i> Refresh</button>
          <button class="btn btn-success" id="my-location-btn" type="button"><i class="fas fa-location-crosshairs"></i> My Location</button>
        </div>
      </div>
    </div>
    <div id="hide" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-gem"></i> Hide a Coin</h2>
        <form id="hide-coin-form" autocomplete="off">
          <div class="form-group">
            <label for="coin-title"><i class="fas fa-tag"></i> Coin Title</label>
            <input type="text" class="form-control" id="coin-title" required maxlength="64" placeholder="Enter coin name...">
          </div>
          <div class="form-group">
            <label for="coin-desc"><i class="fas fa-align-left"></i> Description</label>
            <textarea class="form-control" id="coin-desc" rows="3" required maxlength="160" placeholder="Describe your coin (max 160 chars)"></textarea>
          </div>
          <div class="form-group">
            <label for="coin-rarity"><i class="fas fa-layer-group"></i> Rarity</label>
            <select class="form-control" id="coin-rarity">
              <option value="common">‚ö™ Common</option>
              <option value="rare">üîµ Rare</option>
              <option value="epic">üü£ Epic</option>
              <option value="legendary">üü° Legendary</option>
            </select>
          </div>
          <div class="form-group">
            <label><i class="fas fa-camera"></i> Upload Pictures (Max 2)</label>
            <div class="image-upload-container">
              <div class="image-upload-box" id="upload-box-1" tabindex="0"><i class="fas fa-cloud-upload-alt"></i><p>Click to upload<br>Picture 1</p><input type="file" id="image-1" accept="image/*" hidden><button type="button" class="remove-image" tabindex="-1"><i class="fas fa-times"></i></button></div>
              <div class="image-upload-box" id="upload-box-2" tabindex="0"><i class="fas fa-cloud-upload-alt"></i><p>Click to upload<br>Picture 2</p><input type="file" id="image-2" accept="image/*" hidden><button type="button" class="remove-image" tabindex="-1"><i class="fas fa-times"></i></button></div>
            </div>
          </div>
          <div class="form-group">
            <label for="coin-location-text"><i class="fas fa-map-pin"></i> Select Location on Map</label>
            <div id="location-picker" class="location-picker"></div>
            <input type="text" class="form-control mt-10" id="coin-location-text" readonly>
          </div>
          <button type="submit" class="btn btn-primary w-100" id="hide-btn" style="padding:15px;font-size:1.09rem;"><i class="fas fa-cloud-upload-alt"></i> Hide Coin</button>
        </form>
      </div>
    </div>
    <div id="find" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-search-location"></i> Find Coins</h2>
        <div id="coin-grid" class="coin-grid"></div>
      </div>
    </div>
    <div id="profiles" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-trophy"></i> Top Players</h2>
        <div id="profiles-list" class="profiles-grid"></div>
      </div>
    </div>
  </div>
  <div id="auth-modal" class="modal" tabindex="-1">
    <div class="modal-content">
      <h3>üéÆ Join the Hunt</h3>
      <div class="form-group"><label for="auth-username">Your Name</label>
        <input type="text" class="form-control" id="auth-username" placeholder="Enter your name..." autocomplete="nickname" required maxlength="30">
      </div>
      <div class="form-group">
        <button class="btn btn-success w-100" id="login-btn" type="button"><i class="fas fa-search"></i> Play as Finder</button>
        <button class="btn btn-primary w-100 mt-10" id="hider-login-btn" type="button"><i class="fas fa-gem"></i> Login as Hider</button>
        <button class="btn w-100 mt-10" style="background:rgba(255,255,255,0.23);color:#fff" id="guest-btn" type="button"><i class="fas fa-eye"></i> Guest</button>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --------- Firebase App ---------
    const app = firebase.initializeApp({
      apiKey: "AIzaSyAiF_EIhTkbkik4U1Y7T9nM0qIZCYDPLw4",
      authDomain: "hidecoin-sofia-public.firebaseapp.com",
      databaseURL: "https://hidecoin-sofia-public-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hidecoin-sofia-public",
      storageBucket: "hidecoin-sofia-public.appspot.com",
      messagingSenderId: "756894260998",
      appId: "1:756894260998:web:da7b06d6b857273d0dac8c"
    });
    const db = firebase.database(), storage = firebase.storage();
    // --------- State ---------
    let user = null, role = "guest";
    let coins = [], markers = [];
    let uploadedImages = {1: null, 2: null};
    let map = null, locMap = null, lat = 42.6977, lng = 23.3219;
    // --------- Utils ---------
    function msg(t,c) {
      const m=document.createElement('div');
      m.className="message";
      m.textContent = t;
      if(c === "success") m.style.background = "linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)";
      else if (c==="error") m.style.background = "linear-gradient(135deg,#f093fb 0%,#f5576c 100%)";
      else m.style.background = "linear-gradient(135deg,#667eea 0%,#764ba2 100%)";
      document.body.appendChild(m);
      setTimeout(()=>m.remove(),3100);
    }
    function showLoading(targetId) {
      const el = document.getElementById(targetId);
      el.innerHTML = '<div class="text-center" style="padding:40px;font-size:1.1rem;color:rgba(255,255,255,0.81)"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
    }
    // --------- UI Update ---------
    function updateUI() {
      const b=document.getElementById('auth-btn');
      const i=document.getElementById('user-info');
      const rb=document.getElementById('user-role-badge');
      const n=document.getElementById('user-name');
      if(user){
        b.innerHTML='<i class="fas fa-user-circle"></i> '+user.displayName;
        i.classList.remove('d-none');
        n.textContent = 'Logged in as: '+user.displayName;
        rb.textContent = role === "hider" ? 'üé® Hider': 'üîç Finder';
        rb.className = "badge " + (role==="hider"?"badge-hider":"badge-finder");
      } else{
        b.innerHTML = '<i class="fas fa-user"></i> Login';
        i.classList.add('d-none');
      }
    }
    // --------- Firebase Functions ---------
    function loadCoins(loading=true){
      if(loading) showLoading('coin-grid');
      db.ref('coins').once('value').then(s=>{
        coins = [];
        const d = s.val();
        if(d) Object.keys(d).forEach(k => coins.push({id:k, ...d[k]}));
        updateStats();
        updateGrid();
        if(map) updateMap();
      }).catch(e => { msg("Load error","error"); });
    }
    function updateStats() {
      document.getElementById('total-coins').textContent = coins.length;
      document.getElementById('found-coins').textContent = coins.filter(c=>c.found).length;
      document.getElementById('my-found-coins').textContent = user ? coins.filter(c => c.found&&c.foundBy==user.displayName).length : '0';
    }
    function updateGrid() {
      const g = document.getElementById('coin-grid');
      const av = coins.filter(c=>!c.found);
      if(!av.length) { g.innerHTML=`<div class="text-center" style="color:rgba(255,255,255,0.91);grid-column:1/-1;font-size:1.04rem">No coins available. Try hiding some!</div>`; return;}
      g.innerHTML = '';
      av.forEach(c=>{
        const colors = {common: '#84fab0', rare: '#76baff', epic:'#d58cff', legendary:"#ffe484"};
        let imgHtml = '';
        if(c.images&&c.images.length>0) {
          imgHtml = `<div class="coin-images">` + c.images.map(url=>`<img src="${url}" class="coin-image" alt="Coin image">`).join('') + "</div>";
        }
        const badgeClr = c.rarity === "legendary" ? "#333" : "#222";
        const card = document.createElement('div');
        card.className = "coin-card";
        card.innerHTML = `
          <h3>üí∞ ${c.title}</h3>
          <p style="word-break:break-word;">${c.description}</p>
          ${imgHtml}
          <div class="rarity-badge" style="background:${colors[c.rarity]};color:${badgeClr};margin-bottom:0.2em">${c.rarity.toUpperCase()}</div>
          <p style="color:rgba(255,255,255,0.7);margin:10px 0 5px 0;font-size:0.92rem">
            <i class="fas fa-user-secret"></i> ${c.hiddenBy}
          </p>
          <button onclick="window._findCoin('${c.id}')" class="btn btn-success" style="width:100%;font-weight:bold"><i class="fas fa-search"></i> Find</button>
        `;
        g.appendChild(card);
      });
    }
    function updateProfiles(loading=true){
      const pl=document.getElementById('profiles-list');
      if(loading) showLoading('profiles-list');
      db.ref('players').once('value').then(s=>{
        const players={};
        const d = s.val();
        if(d) Object.keys(d).forEach(k => players[k]=d[k]);
        coins.forEach(c=>{
          if(c.found && c.foundBy && c.foundBy!='Guest'){
            const n = c.foundBy.replace(/[.#$/[\]]/g, '_');
            if(!players[n]) players[n] = {name:c.foundBy,coinsFound:0};
            players[n].coinsFound = (players[n].coinsFound||0)+1;
          }
        });
        const arr = Object.values(players).sort((a,b)=>(b.coinsFound||0)-(a.coinsFound||0));
        if(!arr.length){
          pl.innerHTML = `<div class="text-center" style="color:rgba(255,255,255,0.91);">No players yet!</div>`;
          return;
        }
        pl.innerHTML = '';
        arr.forEach((p,i)=>{
          const medals = ['ü•á','ü•à','ü•â'];
          const pc = document.createElement("div");
          pc.className = "profile-card";
          pc.innerHTML = `
            <div style="font-size:2.8rem;margin-bottom:7px">${medals[i]||'üèÜ'}</div>
            <h4>${p.name}</h4>
            <div class="profile-stats"><strong>${p.coinsFound||0}</strong> coins</div>
          `;
          pl.appendChild(pc);
        });
      }).catch(e=>{pl.innerHTML = `<div class="text-center">Load error</div>`;});
    }
    // --------- Map ---------
    function initMap() {
      const c = document.getElementById('map-container');
      if (!c) return;
      if (map) { map.remove(); markers = []; }
      map = L.map('map-container').setView([42.6977, 23.3219], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      updateMap();
    }
    function updateMap() {
      if (!map) return;
      markers.forEach(m => { if(map && m) map.removeLayer(m); });
      markers = [];
      coins.forEach(c => {
        if (!c.found) {
          const colors = {common:'#84fab0', rare:'#76baff', epic:'#d58cff', legendary:'#ffe484'};
          const ic = L.divIcon({
            html: `<div style="background:${colors[c.rarity]};width:31px;height:31px;border-radius:50%;border:2px solid white;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 7px rgba(0,0,0,0.19)"><div style="font-size:1.1rem">üí∞</div></div>`,
            iconSize: [31, 31]
          });
          const m = L.marker([c.lat, c.lng], {icon: ic}).addTo(map);
          let imgHtml = '';
          if (c.images && c.images.length > 0) {
            imgHtml = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin:7px 0;">`
              + c.images.map(url => `<img src="${url}" style="width:100%;height:71px;object-fit:cover;border-radius:6px;">`).join("")
              + "</div>";
          }
          m.bindPopup(
            `<div style="color:#222;font-weight:600;min-width:160px;"><strong>${c.title}</strong><br><small>${c.description}</small>${imgHtml}<p style="margin-top:7px;font-size:.90rem;color:#222;"><i class="fas fa-user-secret"></i> ${c.hiddenBy}</p></div>`
          );
          markers.push(m);
        }
      });
    }
    function initLocationPicker() {
      const lp = document.getElementById('location-picker');
      if (!lp) return;
      if (locMap) { locMap.remove(); locMap=null; }
      locMap = L.map('location-picker').setView([lat,lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(locMap);
      const marker = L.marker([lat, lng]).addTo(locMap);
      locMap.on("click", e => {
        lat = e.latlng.lat; lng = e.latlng.lng;
        marker.setLatLng(e.latlng);
        document.getElementById('coin-location-text').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      });
      document.getElementById('coin-location-text').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }
    // --------- UI/UX Functions ---------
    function findCoin(id){
      if(!user){ msg("Please login first!","error"); return; }
      const c = coins.find(x=>x.id==id);
      if(!c) return;
      db.ref("coins/"+id).update({found:true,foundBy:user.displayName}).then(()=>{
        msg(`üéâ Found: ${c.title}!`,"success");
        loadCoins(false); updateProfiles(false);
      }).catch(e => { msg("Error marking coin as found","error"); });
    }
    window._findCoin = findCoin;
    // --------- Tab Navigation ---------
    function setupTabNavigation(){
      document.querySelectorAll('.nav-link').forEach(link=>{
        link.addEventListener('click',e=>{
          e.preventDefault();
          const tab = link.dataset.tab;
          document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
          document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
          document.getElementById(tab).classList.add('active');
          link.classList.add('active');
          if(tab=="map") setTimeout(initMap,90);
          if(tab=="hide") setTimeout(initLocationPicker,100);
        });
      });
    }
    function setupEventListeners(){
      document.getElementById('auth-btn').addEventListener('click',()=>{
        if(user) { user=null; role='guest'; updateUI(); msg("Logged out!","success"); }
        else { showModal("auth-modal"); }
      });
      document.getElementById('guest-btn').addEventListener('click',()=>{
        user={displayName:"Guest"};role='guest';
        hideModal("auth-modal");updateUI();msg("Welcome, Guest!","success");
      });
      document.getElementById('login-btn').addEventListener('click',()=>{
        const name = document.getElementById('auth-username').value.trim();
        if(!name) { msg("Please enter your name","error");return; }
        user={displayName:name}; role="finder";
        hideModal("auth-modal"); updateUI();msg(`Welcome, ${name}!`,"success");
      });
      document.getElementById('hider-login-btn').addEventListener('click',()=>{
        const pwd = prompt("Enter Hider Password:");
        if(pwd!=="hider123") { msg("Wrong password!","error");return; }
        const name=document.getElementById('auth-username').value.trim();
        if(!name) {msg("Please enter your name","error"); return;}
        user={displayName:name}; role="hider";
        hideModal("auth-modal");updateUI();msg(`Welcome, Hider ${name}!`,"success");
      });
      document.getElementById('logout-btn').addEventListener('click',()=>{
        user=null;role='guest';updateUI();msg("Logged out!","success");
      });
      // Modal click to close
      document.getElementById('auth-modal').addEventListener('mousedown',(e)=>{
        if(e.target===document.getElementById('auth-modal'))
          hideModal("auth-modal");
      });
      // Hide coin form
      document.getElementById('hide-coin-form').addEventListener('submit', async e => {
        e.preventDefault();
        if(!user||role!=="hider"){ msg("Only hiders can hide coins!","error");return;}
        const title = document.getElementById("coin-title").value.trim();
        const desc = document.getElementById("coin-desc").value.trim();
        const rarity = document.getElementById("coin-rarity").value;
        const imgs = [];
        document.getElementById('hide-btn').disabled = true;
        try {
          for(let i=1;i<=2;i++){
            if(uploadedImages[i]){
              const ref = storage.ref(`coins/${user.displayName}_${Date.now()}_${i}`);
              await ref.put(uploadedImages[i]);
              const url = await ref.getDownloadURL();
              imgs.push(url);
            }
          }
          const coinData = { title, description: desc, rarity, lat, lng, hiddenBy: user.displayName, images: imgs, found: false, createdAt: new Date().toISOString() };
          await db.ref('coins').push(coinData);
          msg("Coin hidden successfully! ü™ô","success");
          document.getElementById('hide-coin-form').reset();
          uploadedImages = {1:null,2:null};
          document.getElementById('upload-box-1').classList.remove('has-image');
          document.getElementById('upload-box-2').classList.remove('has-image');
          loadCoins(false);
        } catch (err) {
          msg('Error hiding coin!','error');
        } finally {
          document.getElementById('hide-btn').disabled = false;
        }
      });
      // Hide/view image upload logic
      for(let i=1;i<=2;i++){
        const box = document.getElementById('upload-box-'+i);
        box.addEventListener("click",()=> document.getElementById('image-'+i).click());
        box.querySelector('input[type="file"]').addEventListener('change',e=>{
          if(e.target.files[0]){
            uploadedImages[i] = e.target.files[0];
            box.classList.add('has-image');
          }
        });
        box.querySelector('.remove-image').addEventListener('click',e=>{
          e.stopPropagation();
          uploadedImages[i]=null;
          box.classList.remove('has-image');
          box.querySelector('input[type="file"]').value="";
        });
      }
      // Map buttons
      document.getElementById('refresh-map-btn').addEventListener('click', ()=>{
        loadCoins(false);msg("Map refreshed!","success");
      });
      document.getElementById('my-location-btn').addEventListener('click',()=>{
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(pos=>{
            const {latitude,longitude}=pos.coords;
            if(map) map.setView([latitude,longitude],15);
            msg("Location found!","success");
          },()=>msg("Could not get your location","error"));
        }
      });
    }
    function showModal(id) {
      document.getElementById(id).classList.add("show");
      document.getElementById(id).focus();
    }
    function hideModal(id) {
      document.getElementById(id).classList.remove("show");
    }
    // --------- Init ---------
    document.addEventListener("DOMContentLoaded",function(){
      loadCoins();
      updateProfiles();
      setupTabNavigation();
      setupEventListeners();
      setInterval(()=>{ loadCoins(false); }, 13000);
    });
  </script>
</body>
</html>
